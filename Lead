public with sharing class agentHandlerClass

    public static void createnewuser(list<Agent__c>NewRecords, list<Agent__c> oldRecords)  
	{
		Profile AgentProfileId =[SELECT Id FROM Profile WHERE Name ='Insurance Agent Department'];
		list<User> AgentLogin = new list<User>();
		for( Agent__C oldAge : oldRecords)
		{
			if(oldAge.Request_Status__c != 'Approved' && oldAge.user_creation__c !='Yes')
				{
					for(Agent__C newAge : NewRecords)
					{
						if( newAge.Request_Status__c == 'Approved' && newAge.user_creation__c =='Yes')
							{
								User u = new User();
								string nickname = newAge.Name__c;
								u.LastName = 'Agent';
								u.FirstName = newAge.Name__c;
								u.Email = newAge.Email__c;
								u.Alias='agt'+nickname.substring(5,9);
								u.CommunityNickname ='Agent'+newAge.Name;
								u.Username = newAge.Name+'@Lemonade.net';
								u.CommunityNickname = newAge.Name__c;
								u.ProfileId = AgentProfileId.id;
								u.EmailEncodingKey = 'ISO-8859-1';
								u.TimeZoneSidKey = 'America/Los_Angeles';
								u.LanguageLocaleKey  = 'en_US';
								u.LocaleSidKey = 'en_US';
								u.ContactId = '0032w00000mZwDRAA0';
								u.Agent_Record_ID__c= newAge.id;
								AgentLogin.add(u);
							}
					}
				}
		}
		insert AgentLogin;
	}
